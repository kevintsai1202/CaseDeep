-- Admin API 測試數據（可重複執行，避免重複）
-- 注意：請於測試環境使用，避免污染正式資料庫

-- 1) 角色（補齊Admin模組所需權限）
INSERT INTO t_role (ROLENAME, DESCRIPTION, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'ROLE_ORDER_MANAGE', 'Admin can manage orders', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_role WHERE ROLENAME='ROLE_ORDER_MANAGE');

INSERT INTO t_role (ROLENAME, DESCRIPTION, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'ROLE_COMMISSION_MANAGE', 'Admin can manage commissions', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_role WHERE ROLENAME='ROLE_COMMISSION_MANAGE');

INSERT INTO t_role (ROLENAME, DESCRIPTION, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'ROLE_UPGRADE_MANAGE', 'Admin can manage upgrades', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_role WHERE ROLENAME='ROLE_UPGRADE_MANAGE');

INSERT INTO t_role (ROLENAME, DESCRIPTION, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'ROLE_INVITE_MANAGE', 'Admin can manage invitations', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_role WHERE ROLENAME='ROLE_INVITE_MANAGE');

-- 2) 測試用使用者（管理者/供應商/客戶）
-- 管理者（如已存在則跳過） 密碼同 data.sql 的加密版 Abc123
INSERT INTO t_user (USERNAME, PASSWORD, EMAIL, SEND_VERIFY_FLAG, SEND_RESET_FLAG, CERTIFIED, LOCKED, USER_TYPE, RANKING_SCORE, DISPLAY_ORDER, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'qa_admin', '$2a$10$WpjtzpaCJAFaL2jfXvCtSOK2dpj0cJZbJdg3U9nTbuheOebuzYEfm', 'qa_admin@casemgr.com', false, false, true, false, 'ADMIN', 0.0, 0, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_user WHERE USERNAME = 'qa_admin');

-- 供應商
INSERT INTO t_user (USERNAME, PASSWORD, EMAIL, SEND_VERIFY_FLAG, SEND_RESET_FLAG, CERTIFIED, LOCKED, USER_TYPE, RANKING_SCORE, DISPLAY_ORDER, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'qa_provider', '$2a$10$WpjtzpaCJAFaL2jfXvCtSOK2dpj0cJZbJdg3U9nTbuheOebuzYEfm', 'qa_provider@casemgr.com', false, false, true, false, 'PROVIDER', 0.0, 0, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_user WHERE USERNAME = 'qa_provider');

-- 客戶
INSERT INTO t_user (USERNAME, PASSWORD, EMAIL, SEND_VERIFY_FLAG, SEND_RESET_FLAG, CERTIFIED, LOCKED, USER_TYPE, RANKING_SCORE, DISPLAY_ORDER, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'qa_client', '$2a$10$WpjtzpaCJAFaL2jfXvCtSOK2dpj0cJZbJdg3U9nTbuheOebuzYEfm', 'qa_client@casemgr.com', false, false, true, false, 'CLIENT', 0.0, 0, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_user WHERE USERNAME = 'qa_client');

-- 將必要的管理權限授予 admin 與 qa_admin
-- admin -> ROLE_ORDER_MANAGE
INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='admin' AND r.ROLENAME='ROLE_ORDER_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

-- admin -> ROLE_COMMISSION_MANAGE
INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='admin' AND r.ROLENAME='ROLE_COMMISSION_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

-- admin -> ROLE_UPGRADE_MANAGE
INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='admin' AND r.ROLENAME='ROLE_UPGRADE_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='admin' AND r.ROLENAME='ROLE_INVITE_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

-- qa_admin -> ROLE_ADMIN/ROLE_ORDER_MANAGE/ROLE_COMMISSION_MANAGE/ROLE_UPGRADE_MANAGE
INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='qa_admin' AND r.ROLENAME='ROLE_ADMIN'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='qa_admin' AND r.ROLENAME='ROLE_ORDER_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='qa_admin' AND r.ROLENAME='ROLE_COMMISSION_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='qa_admin' AND r.ROLENAME='ROLE_UPGRADE_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

INSERT INTO t_user_role (USER_ID, ROLE_ID)
SELECT u.ID, r.ID FROM t_user u, t_role r
WHERE u.USERNAME='qa_admin' AND r.ROLENAME='ROLE_INVITE_MANAGE'
AND NOT EXISTS (SELECT 1 FROM t_user_role ur WHERE ur.USER_ID=u.ID AND ur.ROLE_ID=r.ID);

-- 3) 產業別（Industry）
INSERT INTO t_industry (NAME, DESCRIPTION, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'IT', 'Information Technology', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_industry WHERE NAME='IT');

-- 抓取各ID供後續關聯
-- 注意：此段為MySQL用法；不同DB可改寫
SET @ADMIN_ID = (SELECT ID FROM t_user WHERE USERNAME='admin');
SET @QA_ADMIN_ID = (SELECT ID FROM t_user WHERE USERNAME='qa_admin');
SET @PROVIDER_ID = (SELECT ID FROM t_user WHERE USERNAME='qa_provider');
SET @CLIENT_ID   = (SELECT ID FROM t_user WHERE USERNAME='qa_client');
SET @INDUSTRY_ID = (SELECT ID FROM t_industry WHERE NAME='IT');

-- 4) 訂單（Order）最小可用資料
INSERT INTO t_order (ORDER_NUMBER, NAME, ORDER_TYPE, STATUS, TOTAL_PRICE, PROVIDER_ID, CLIENT_ID, INDUSTRY_ID, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'ORD-TEST-0001', 'Test Order 1', 'DIRECT', 'CREATED', 1000.00, @PROVIDER_ID, @CLIENT_ID, @INDUSTRY_ID, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_order WHERE ORDER_NUMBER='ORD-TEST-0001');

SET @ORDER_ID = (SELECT ID FROM t_order WHERE ORDER_NUMBER='ORD-TEST-0001');

-- 5) 佣金（Commission）
INSERT INTO t_commission (COMMISSION_ID_STR, ORDER_ID, AMOUNT, RATE, PAYMENT_STATUS, PAYMENT_DATE, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'CO2501010001', @ORDER_ID, 100.00, 0.1, 'UNPAID', NULL, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_commission WHERE COMMISSION_ID_STR='CO2501010001');

-- 6) 分潤（RevenueShare）
INSERT INTO t_revenue_share (REVENUE_SHARE_NO, ORDER_ID, CLIENT_ID, PROVIDER_ID, INDUSTRY_ID, REVENUE_SHARE_RATE, ORDER_AMOUNT, REVENUE_SHARE_AMOUNT, STATUS, PAYMENT_TIME, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'RS250101000001', @ORDER_ID, @CLIENT_ID, @PROVIDER_ID, @INDUSTRY_ID, 0.1, 1000.00, 100.00, 'UNPAID', NULL, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_revenue_share WHERE REVENUE_SHARE_NO='RS250101000001');

-- 7) 升等（Upgrade）
INSERT INTO t_upgrade (UPGRADE_ID_STR, AMOUNT, UPGRADE_DATE, STATUS, USER_ID, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'UP2501010001', 500.00, NOW(), 'PENDING', @CLIENT_ID, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_upgrade WHERE UPGRADE_ID_STR='UP2501010001');

-- 8) 認證（Certification）— 最小資料（允許部分欄位為NULL）
INSERT INTO t_certification (CE_NO, APPLICANT_ID, AUDITOR_ID, STATUS, EXEMPTION_CODE, REVIEW_DATA, INITIAL_RATING, REVIEW_HISTORY, SIGN_NAME, SCORE, REJECT_COMMENT, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'CE2501010001', @PROVIDER_ID, @ADMIN_ID, 'PENDING', NULL, NULL, NULL, NULL, NULL, NULL, NULL, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_certification WHERE CE_NO='CE2501010001');

-- 9) 邀請（Invitation）
INSERT INTO t_invitation (INVITATION_ID_STR, INVITATION_CODE, REWARD_AMOUNT, STATUS, CREATION_TIME, REWARD_PAYMENT_TIME, INVITING_USER_ID, INVITED_USER_ID, PAYER_ID, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'IN2501010001', 'QA-INV-0001', 50.00, 'PENDING', NOW(), NULL, @ADMIN_ID, @CLIENT_ID, NULL, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_invitation WHERE INVITATION_ID_STR='IN2501010001');

-- 10) 貨幣（Currency）
INSERT INTO t_currency (CURRENCY, CURRENCY_SYMBOL, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'TWD', 'NT$', true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_currency WHERE CURRENCY='TWD');

-- 11) 系統清單（SysListItem）
INSERT INTO t_syslistitem (NAME, DESCRIPTION, SORT, TYPE, ICON_URL, ENABLED, CREATE_TIME, UPDATE_TIME)
SELECT 'Category-A', 'Category for testing', 1, 'CATEGORY', NULL, true, NOW(), NOW()
WHERE NOT EXISTS (SELECT 1 FROM t_syslistitem WHERE NAME='Category-A' AND TYPE='CATEGORY');
