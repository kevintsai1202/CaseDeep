{
  "info": {
    "name": "P1-Role-Controller",
    "description": "角色管理控制器完整測試集合 - 包含角色CRUD操作、權限驗證、邊界條件測試等完整測試場景",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{adminToken}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全域前置腳本 - 角色管理測試",
          "console.log('=== 角色管理測試前置腳本 ===');",
          "",
          "// 檢查管理員Token",
          "if (!pm.environment.get('adminToken')) {",
          "    console.error('❌ 管理員Token未設置，請先執行認證測試');",
          "    throw new Error('管理員Token未設置');",
          "}",
          "",
          "// 設置基礎URL",
          "pm.environment.set('baseUrl', 'http://localhost:8080');",
          "",
          "// 設置測試資料",
          "pm.environment.set('testRoleName', 'TEST_ROLE_' + Date.now());",
          "pm.environment.set('testRoleDescription', '測試角色描述');",
          "pm.environment.set('updatedRoleName', 'UPDATED_ROLE_' + Date.now());",
          "pm.environment.set('updatedRoleDescription', '更新後的角色描述');",
          "",
          "// 通用測試函數",
          "pm.globals.set('validateRoleResponse', `",
          "function validateRoleResponse(responseJson, expectedFields = []) {",
          "    pm.test('回應格式驗證', function() {",
          "        pm.expect(responseJson).to.be.an('object');",
          "        pm.expect(responseJson).to.have.property('id');",
          "        pm.expect(responseJson).to.have.property('roleName');",
          "        pm.expect(responseJson).to.have.property('description');",
          "        pm.expect(responseJson.id).to.be.a('number');",
          "        pm.expect(responseJson.roleName).to.be.a('string');",
          "    });",
          "    ",
          "    expectedFields.forEach(field => {",
          "        pm.test('包含必要欄位: ' + field.name, function() {",
          "            pm.expect(responseJson).to.have.property(field.name);",
          "            if (field.value !== undefined) {",
          "                pm.expect(responseJson[field.name]).to.equal(field.value);",
          "            }",
          "        });",
          "    });",
          "}",
          "`);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全域測試腳本",
          "pm.test('回應時間檢查', function() {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});",
          "",
          "pm.test('Content-Type檢查', function() {",
          "    pm.expect(pm.response.headers.get('Content-Type')).to.include('application/json');",
          "});"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "角色查詢管理",
      "item": [
        {
          "name": "獲取所有角色列表",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為200', function() {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('回應應為陣列格式', function() {",
                  "    const responseJson = pm.response.json();",
                  "    pm.expect(responseJson).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('角色列表結構驗證', function() {",
                  "    const responseJson = pm.response.json();",
                  "    if (responseJson.length > 0) {",
                  "        const firstRole = responseJson[0];",
                  "        pm.expect(firstRole).to.have.property('id');",
                  "        pm.expect(firstRole).to.have.property('roleName');",
                  "        pm.expect(firstRole).to.have.property('description');",
                  "        pm.expect(firstRole.id).to.be.a('number');",
                  "        pm.expect(firstRole.roleName).to.be.a('string');",
                  "    }",
                  "});",
                  "",
                  "// 儲存第一個角色ID供後續測試使用",
                  "const responseJson = pm.response.json();",
                  "if (responseJson.length > 0) {",
                  "    pm.environment.set('existingRoleId', responseJson[0].id);",
                  "    pm.environment.set('existingRoleName', responseJson[0].roleName);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "根據ID獲取角色詳情",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// 檢查是否有可用的角色ID",
                  "if (!pm.environment.get('existingRoleId')) {",
                  "    console.log('⚠️ 沒有可用的角色ID，將使用預設值1');",
                  "    pm.environment.set('existingRoleId', '1');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為200', function() {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const responseJson = pm.response.json();",
                  "eval(pm.globals.get('validateRoleResponse'));",
                  "validateRoleResponse(responseJson);",
                  "",
                  "pm.test('角色ID匹配', function() {",
                  "    const expectedId = parseInt(pm.environment.get('existingRoleId'));",
                  "    pm.expect(responseJson.id).to.equal(expectedId);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/{{existingRoleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "{{existingRoleId}}"]
            }
          }
        },
        {
          "name": "查詢不存在的角色",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為404', function() {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('回應內容為空', function() {",
                  "    pm.expect(pm.response.text()).to.be.empty;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/99999",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "99999"]
            }
          }
        }
      ]
    },
    {
      "name": "角色創建管理",
      "item": [
        {
          "name": "創建新角色",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為201', function() {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const responseJson = pm.response.json();",
                  "eval(pm.globals.get('validateRoleResponse'));",
                  "validateRoleResponse(responseJson, [",
                  "    { name: 'roleName', value: pm.environment.get('testRoleName') },",
                  "    { name: 'description', value: pm.environment.get('testRoleDescription') }",
                  "]);",
                  "",
                  "// 儲存創建的角色ID供後續測試使用",
                  "pm.environment.set('createdRoleId', responseJson.id);",
                  "",
                  "pm.test('角色名稱正確', function() {",
                  "    pm.expect(responseJson.roleName).to.equal(pm.environment.get('testRoleName'));",
                  "});",
                  "",
                  "pm.test('角色描述正確', function() {",
                  "    pm.expect(responseJson.description).to.equal(pm.environment.get('testRoleDescription'));",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"{{testRoleName}}\",\n  \"description\": \"{{testRoleDescription}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "創建重複角色名稱",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為400或409', function() {",
                  "    pm.expect(pm.response.code).to.be.oneOf([400, 409]);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"{{testRoleName}}\",\n  \"description\": \"重複的角色描述\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "創建角色 - 缺少必要欄位",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為400', function() {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"description\": \"缺少角色名稱的測試\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "創建角色 - 角色名稱過長",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為400', function() {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"THIS_IS_A_VERY_LONG_ROLE_NAME_THAT_EXCEEDS_THE_MAXIMUM_LENGTH_LIMIT_OF_FIFTY_CHARACTERS\",\n  \"description\": \"測試角色名稱長度限制\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        }
      ]
    },
    {
      "name": "角色更新管理",
      "item": [
        {
          "name": "更新角色資訊",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// 檢查是否有創建的角色ID",
                  "if (!pm.environment.get('createdRoleId')) {",
                  "    console.log('⚠️ 沒有創建的角色ID，將使用現有角色ID');",
                  "    pm.environment.set('createdRoleId', pm.environment.get('existingRoleId') || '1');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為200', function() {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const responseJson = pm.response.json();",
                  "eval(pm.globals.get('validateRoleResponse'));",
                  "validateRoleResponse(responseJson, [",
                  "    { name: 'roleName', value: pm.environment.get('updatedRoleName') },",
                  "    { name: 'description', value: pm.environment.get('updatedRoleDescription') }",
                  "]);",
                  "",
                  "pm.test('角色ID保持不變', function() {",
                  "    const expectedId = parseInt(pm.environment.get('createdRoleId'));",
                  "    pm.expect(responseJson.id).to.equal(expectedId);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"{{updatedRoleName}}\",\n  \"description\": \"{{updatedRoleDescription}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/{{createdRoleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "{{createdRoleId}}"]
            }
          }
        },
        {
          "name": "更新不存在的角色",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為404', function() {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"NON_EXISTENT_ROLE\",\n  \"description\": \"測試不存在的角色更新\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/99999",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "99999"]
            }
          }
        },
        {
          "name": "更新角色 - 無效資料",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為400', function() {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"roleName\": \"\",\n  \"description\": \"空白角色名稱測試\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/{{createdRoleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "{{createdRoleId}}"]
            }
          }
        }
      ]
    },
    {
      "name": "角色刪除管理",
      "item": [
        {
          "name": "刪除角色",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// 檢查是否有創建的角色ID",
                  "if (!pm.environment.get('createdRoleId')) {",
                  "    console.log('⚠️ 沒有創建的角色ID，跳過刪除測試');",
                  "    pm.environment.set('skipDelete', 'true');",
                  "} else {",
                  "    pm.environment.set('skipDelete', 'false');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.environment.get('skipDelete') === 'true') {",
                  "    pm.test.skip('跳過刪除測試 - 沒有可刪除的角色');",
                  "    return;",
                  "}",
                  "",
                  "pm.test('狀態碼應為204', function() {",
                  "    pm.response.to.have.status(204);",
                  "});",
                  "",
                  "pm.test('回應內容為空', function() {",
                  "    pm.expect(pm.response.text()).to.be.empty;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/{{createdRoleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "{{createdRoleId}}"]
            }
          }
        },
        {
          "name": "刪除不存在的角色",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為404', function() {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/99999",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "99999"]
            }
          }
        },
        {
          "name": "驗證角色已被刪除",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// 檢查是否有創建的角色ID",
                  "if (!pm.environment.get('createdRoleId') || pm.environment.get('skipDelete') === 'true') {",
                  "    console.log('⚠️ 跳過刪除驗證測試');",
                  "    pm.environment.set('skipDeleteVerify', 'true');",
                  "} else {",
                  "    pm.environment.set('skipDeleteVerify', 'false');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.environment.get('skipDeleteVerify') === 'true') {",
                  "    pm.test.skip('跳過刪除驗證測試');",
                  "    return;",
                  "}",
                  "",
                  "pm.test('狀態碼應為404', function() {",
                  "    pm.response.to.have.status(404);",
                  "});",
                  "",
                  "pm.test('已刪除的角色無法查詢', function() {",
                  "    pm.expect(pm.response.text()).to.be.empty;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/{{createdRoleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "{{createdRoleId}}"]
            }
          }
        }
      ]
    },
    {
      "name": "安全性測試",
      "item": [
        {
          "name": "無Token訪問測試",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為401', function() {",
                  "    pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "無效Token訪問測試",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼應為401', function() {",
                  "    pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [
                {
                  "key": "token",
                  "value": "invalid_token_12345",
                  "type": "string"
                }
              ]
            },
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles"]
            }
          }
        },
        {
          "name": "SQL注入測試",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('狀態碼不應為200 (防SQL注入)', function() {",
                  "    pm.expect(pm.response.code).to.not.equal(200);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/admin/roles/1' OR '1'='1",
              "host": ["{{baseUrl}}"],
              "path": ["api", "admin", "roles", "1' OR '1'='1"]
            }
          }
        }
      ]
    },
    {
      "name": "清理測試資料",
      "item": [
        {
          "name": "清理環境變數",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// 清理測試過程中創建的環境變數",
                  "pm.environment.unset('testRoleName');",
                  "pm.environment.unset('testRoleDescription');",
                  "pm.environment.unset('updatedRoleName');",
                  "pm.environment.unset('updatedRoleDescription');",
                  "pm.environment.unset('createdRoleId');",
                  "pm.environment.unset('existingRoleId');",
                  "pm.environment.unset('existingRoleName');",
                  "pm.environment.unset('skipDelete');",
                  "pm.environment.unset('skipDeleteVerify');",
                  "",
                  "// 清理全域變數",
                  "pm.globals.unset('validateRoleResponse');",
                  "",
                  "pm.test('測試資料清理完成', function() {",
                  "    pm.expect(true).to.be.true;",
                  "});",
                  "",
                  "console.log('✅ 角色管理測試完成，測試資料已清理');"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/health",
              "host": ["{{baseUrl}}"],
              "path": ["api", "health"]
            }
          }
        }
      ]
    }
  ]
}